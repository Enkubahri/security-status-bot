<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Status Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.6;
        }

        .container {
            max-width: 100vw;
            padding: 16px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .nav-tabs {
            display: flex;
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background-color: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-primary:hover {
            opacity: 0.8;
        }

        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
        }

        .report-card {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
        }

        .report-card h3 {
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-meta {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-safe {
            background-color: #4ade80;
            color: #ffffff;
        }

        .status-warning {
            background-color: #fbbf24;
            color: #000000;
        }

        .status-danger {
            background-color: #ef4444;
            color: #ffffff;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .admin-panel {
            margin-top: 20px;
        }

        .focal-person-item {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-message {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .success-message {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-shield-alt"></i>
                Security Status
            </h1>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('reports')">
                <i class="fas fa-list"></i> Reports
            </div>
            <div class="nav-tab" onclick="switchTab('submit')">
                <i class="fas fa-plus"></i> Submit
            </div>
            <div class="nav-tab" onclick="switchTab('admin')" id="admin-tab" style="display: none;">
                <i class="fas fa-cog"></i> Admin
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content active">
            <div class="form-group">
                <input type="text" id="search-location" placeholder="Search by location..." onkeyup="filterReports()">
            </div>
            <div id="reports-list" class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading reports...
            </div>
        </div>

        <!-- Submit Report Tab -->
        <div id="submit-tab" class="tab-content">
            <form id="report-form">
                <div class="form-group">
                    <label for="location">
                        <i class="fas fa-map-marker-alt"></i> Location
                    </label>
                    <input type="text" id="location" name="location" required placeholder="Enter location name">
                    <small>Location name must contain only letters and spaces</small>
                </div>

                <div class="form-group">
                    <label for="status">
                        <i class="fas fa-exclamation-triangle"></i> Security Status
                    </label>
                    <select id="status" name="status" required>
                        <option value="">Select status...</option>
                        <option value="Safe">Safe</option>
                        <option value="Caution">Caution</option>
                        <option value="Warning">Warning</option>
                        <option value="Danger">Danger</option>
                        <option value="Emergency">Emergency</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="recommended-action">
                        <i class="fas fa-lightbulb"></i> Recommended Action
                    </label>
                    <textarea id="recommended-action" name="recommended_action" required placeholder="What should people do?"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Submit Report
                </button>
            </form>
        </div>

        <!-- Admin Tab -->
        <div id="admin-tab-content" class="tab-content">
            <div class="admin-panel">
                <h3><i class="fas fa-users"></i> Manage Focal People</h3>
                
                <form id="add-focal-form" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="focal-user-id">User ID</label>
                        <input type="number" id="focal-user-id" name="user_id" required placeholder="Telegram User ID">
                    </div>
                    <div class="form-group">
                        <label for="focal-name">Full Name</label>
                        <input type="text" id="focal-name" name="name" required placeholder="Full name (letters only)">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add Focal Person
                    </button>
                </form>

                <div id="focal-people-list" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading focal people...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // User data from Telegram
        const user = tg.initDataUnsafe?.user;
        const userId = user?.id;
        const userName = user?.first_name || user?.username || 'User';

        // Global variables
        let allReports = [];
        let isAdmin = false;
        let isFocalPerson = false;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            checkUserPermissions();
            loadReports();
        });

        // Check user permissions
        async function checkUserPermissions() {
            if (!userId) return;

            try {
                const response = await fetch('/api/user/permissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': tg.initData
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                isAdmin = data.is_admin;
                isFocalPerson = data.is_focal_person;

                // Show/hide admin tab
                if (isAdmin) {
                    document.getElementById('admin-tab').style.display = 'block';
                    loadFocalPeople();
                }

                // Show/hide submit tab for focal people
                if (!isFocalPerson && !isAdmin) {
                    document.querySelector('[onclick="switchTab(\'submit\')"]').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking permissions:', error);
            }
        }

        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tab + '-tab' + (tab === 'admin' ? '-content' : '')).classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tab === 'reports') {
                loadReports();
            } else if (tab === 'admin' && isAdmin) {
                loadFocalPeople();
            }
        }

        // Load security reports
        async function loadReports() {
            const reportsList = document.getElementById('reports-list');
            reportsList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading reports...</div>';

            try {
                const response = await fetch('/api/reports');
                const reports = await response.json();
                allReports = reports;
                displayReports(reports);
            } catch (error) {
                console.error('Error loading reports:', error);
                reportsList.innerHTML = '<div class="error-message">Failed to load reports</div>';
            }
        }

        // Display reports
        function displayReports(reports) {
            const reportsList = document.getElementById('reports-list');
            
            if (reports.length === 0) {
                reportsList.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><br>No security reports available</div>';
                return;
            }

            const reportsHtml = reports.map(report => {
                const statusClass = getStatusClass(report.status);
                const date = new Date(report.timestamp).toLocaleDateString();
                const time = new Date(report.timestamp).toLocaleTimeString();

                return `
                    <div class="report-card">
                        <h3>
                            <i class="fas fa-map-marker-alt"></i>
                            ${report.location}
                            <span class="status-badge ${statusClass}">${report.status}</span>
                        </h3>
                        <div class="report-meta">
                            <i class="fas fa-user"></i> ${report.reporter_name} â€¢ 
                            <i class="fas fa-clock"></i> ${date} ${time}
                        </div>
                        <p><strong>Recommended Action:</strong> ${report.recommended_action}</p>
                    </div>
                `;
            }).join('');

            reportsList.innerHTML = reportsHtml;
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch(status.toLowerCase()) {
                case 'safe': return 'status-safe';
                case 'warning': 
                case 'danger': 
                case 'emergency': return 'status-danger';
                default: return 'status-warning';
            }
        }

        // Filter reports by location
        function filterReports() {
            const searchTerm = document.getElementById('search-location').value.toLowerCase();
            const filteredReports = allReports.filter(report => 
                report.location.toLowerCase().includes(searchTerm)
            );
            displayReports(filteredReports);
        }

        // Submit security report
        document.getElementById('report-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isFocalPerson && !isAdmin) {
                showMessage('You are not authorized to submit reports', 'error');
                return;
            }

            const formData = new FormData(e.target);
            const reportData = {
                location: formData.get('location'),
                status: formData.get('status'),
                recommended_action: formData.get('recommended_action'),
                user_id: userId,
                user_name: userName
            };

            // Validate location (letters and spaces only)
            if (!/^[a-zA-Z\s]+$/.test(reportData.location)) {
                showMessage('Location must contain only letters and spaces', 'error');
                return;
            }

            try {
                const response = await fetch('/api/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': tg.initData
                    },
                    body: JSON.stringify(reportData)
                });

                if (response.ok) {
                    showMessage('Security report submitted successfully!', 'success');
                    e.target.reset();
                    loadReports();
                    
                    // Send haptic feedback
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    throw new Error('Failed to submit report');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                showMessage('Failed to submit report', 'error');
                tg.HapticFeedback.notificationOccurred('error');
            }
        });

        // Load focal people (admin only)
        async function loadFocalPeople() {
            if (!isAdmin) return;

            const focalList = document.getElementById('focal-people-list');
            focalList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading focal people...</div>';

            try {
                const response = await fetch('/api/admin/focal-people', {
                    headers: {
                        'X-Telegram-Init-Data': tg.initData
                    }
                });
                const focalPeople = await response.json();
                displayFocalPeople(focalPeople);
            } catch (error) {
                console.error('Error loading focal people:', error);
                focalList.innerHTML = '<div class="error-message">Failed to load focal people</div>';
            }
        }

        // Display focal people
        function displayFocalPeople(focalPeople) {
            const focalList = document.getElementById('focal-people-list');
            
            if (focalPeople.length === 0) {
                focalList.innerHTML = '<div class="empty-state">No focal people registered</div>';
                return;
            }

            const focalHtml = focalPeople.map(person => `
                <div class="focal-person-item">
                    <div>
                        <strong>${person.name}</strong><br>
                        <small>ID: ${person.user_id}</small>
                    </div>
                    <button class="btn btn-secondary" onclick="removeFocalPerson(${person.user_id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            focalList.innerHTML = focalHtml;
        }

        // Add focal person (admin only)
        document.getElementById('add-focal-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isAdmin) return;

            const formData = new FormData(e.target);
            const focalData = {
                user_id: parseInt(formData.get('user_id')),
                name: formData.get('name'),
                added_by: userId
            };

            // Validate name (letters and spaces only)
            if (!/^[a-zA-Z\s]+$/.test(focalData.name)) {
                showMessage('Name must contain only letters and spaces', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/focal-people', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': tg.initData
                    },
                    body: JSON.stringify(focalData)
                });

                if (response.ok) {
                    showMessage('Focal person added successfully!', 'success');
                    e.target.reset();
                    loadFocalPeople();
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    throw new Error('Failed to add focal person');
                }
            } catch (error) {
                console.error('Error adding focal person:', error);
                showMessage('Failed to add focal person', 'error');
                tg.HapticFeedback.notificationOccurred('error');
            }
        });

        // Remove focal person (admin only)
        async function removeFocalPerson(focalUserId) {
            if (!isAdmin) return;

            try {
                const response = await fetch(`/api/admin/focal-people/${focalUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Telegram-Init-Data': tg.initData
                    }
                });

                if (response.ok) {
                    showMessage('Focal person removed successfully!', 'success');
                    loadFocalPeople();
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    throw new Error('Failed to remove focal person');
                }
            } catch (error) {
                console.error('Error removing focal person:', error);
                showMessage('Failed to remove focal person', 'error');
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // Show message
        function showMessage(message, type = 'info') {
            // Remove existing messages
            document.querySelectorAll('.error-message, .success-message').forEach(el => el.remove());

            // Create message element
            const messageEl = document.createElement('div');
            messageEl.className = type === 'error' ? 'error-message' : 'success-message';
            messageEl.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}`;

            // Insert at top of active tab
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(messageEl, activeTab.firstChild);

            // Auto remove after 3 seconds
            setTimeout(() => {
                messageEl.remove();
            }, 3000);
        }

        // Set up main button
        tg.MainButton.setText('Close').show().onClick(() => {
            tg.close();
        });
    </script>
</body>
</html>
